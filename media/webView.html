<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src ${webview.cspSource} https:;
                 script-src 'nonce-${nonce}'; style-src ${webview.cspSource} 'unsafe-inline';">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Locust Menu</title>
  <style>
    body { font-family: var(--vscode-font-family); padding: 12px; }
    h1 { margin: 0 0 8px; font-size: 16px; }
    p { margin: 6px 0 12px; color: var(--vscode-descriptionForeground); }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 12px; }
    .row.stack { flex-direction: column; gap: 10px; }
    .row.actions { gap: 8px; }
    button {
      padding: 6px 10px; border: 1px solid var(--vscode-button-border, transparent);
      border-radius: 6px; background: var(--vscode-button-background);
      color: var(--vscode-button-foreground); cursor: pointer;
    }
    button.danger { background: var(--vscode-inputValidation-errorBackground); color: var(--vscode-editor-foreground); }
    label { cursor: pointer; user-select: none; }
  </style>
</head>
<body
  data-cloud="${this.isCloud ? '1' : '0'}"
  data-cloud-started="${cloudStartedFlag}"
  data-local-started="${localStartedFlag}">

  ${this.isCloud ? cloudControls : desktopControls}
  <br>

  <h2>Get Help</h2>
  <p>
    <a href="#" id="linkCopilotPrompts" aria-expanded="false">Copilot prompt examples</a><br>
    <a href="#" id="linkGuide">Beginner Guide</a><br>
    <a href="https://docs.locust.io/en/stable/" target="_blank">Locust Docs</a><br>
    ${supportBlock}
  </p>

  <div id="copilotBox" style="display:none;">
    <h2>Copilot Prompt Examples</h2>
    <ul id="copilotList" style="margin:6px 0 0 18px; padding:0;"></ul>
    <p id="copilotStatus" style="color: var(--vscode-descriptionForeground);"></p>
  </div>

  <script nonce="${nonce}">
    (function () {
      const vscode = acquireVsCodeApi();
      const run = (cmd) => vscode.postMessage({ type: 'run', command: cmd });

      // Debounce to avoid immediate flip-back after start (UI-only smoothing)
      let lastLocalStartAt = 0;
      let lastCloudStartAt = 0;
      const JUST_STARTED_MS = 1200;

      // Helpers to paint labels + disabled state
      const setLocalVisual = (running) => {
        const b = document.getElementById('btnRunLocal');
        if (!b) return;
        b.textContent = running ? 'Running…' : 'Local Test';
        b.toggleAttribute('disabled', running);
      };
      const setCloudVisual = (running) => {
        // Works for both desktop (btnLocustCloud) and cloud (btnRunUI)
        const id = document.getElementById('btnLocustCloud') ? 'btnLocustCloud' : 'btnRunUI';
        const b = document.getElementById(id);
        if (!b) return;
        b.textContent = running ? 'Running…' : 'Cloud Test';
        b.toggleAttribute('disabled', running);
      };

      const isCloud = document.body.getAttribute('data-cloud') === '1';
      const localStarted = document.body.getAttribute('data-local-started') === '1';
      const cloudStarted = document.body.getAttribute('data-cloud-started') === '1';

      // Initial paint
      setLocalVisual(localStarted);
      setCloudVisual(cloudStarted);

      if (isCloud) {
        // Cloud page: only cloud test button present
        const btnRunCloud = document.getElementById('btnRunUI');
        btnRunCloud?.addEventListener('click', () => {
          if (document.body.getAttribute('data-cloud-started') === '1') return;
          lastCloudStartAt = Date.now();
          run('locust.toggleCloudSimple');     // start via toggle
          setCloudVisual(true);                // optimistic UI
        });
      } else {
        // Desktop page: both buttons actionable
        const btnLocal  = document.getElementById('btnRunLocal');
        const btnCloud  = document.getElementById('btnLocustCloud');
        const btnHar    = document.getElementById('btnConvertHar');
        const btnCopilotChat = document.getElementById('btnCopilotChat');

        btnLocal?.addEventListener('click', () => {
          if (document.body.getAttribute('data-local-started') === '1') return;
          lastLocalStartAt = Date.now();
          run('locust.toggleLocalSimple');     // start via toggle
          setLocalVisual(true);                // optimistic UI
        });

        btnCloud?.addEventListener('click', () => {
          if (document.body.getAttribute('data-cloud-started') === '1') return;
          lastCloudStartAt = Date.now();
          run('locust.toggleCloudSimple');     // start via toggle
          setCloudVisual(true);                // optimistic UI
        });

        btnHar?.addEventListener('click', () => run('locust.convertHar'));

        // Copilot Chat button -> open VS Code Chat view
        btnCopilotChat?.addEventListener('click', () => {
          run('workbench.action.chat.openInSidebar');
        });
      }

      // Unified Stop Test
      document.getElementById('btnStopAll')?.addEventListener('click', () => {
        run('locust.stopLocalThenCloudIfAny'); // unified stop (local then cloud)
        setLocalVisual(false);
        setCloudVisual(false);
        // Reset "started" attributes so clicks work again immediately
        document.body.setAttribute('data-local-started', '0');
        document.body.setAttribute('data-cloud-started', '0');
      });

      // Beginner guide
      document.getElementById('linkGuide')?.addEventListener('click', (e) => {
        e.preventDefault();
        run('locust.startBeginnerTour');
      });

      // Copilot prompts (toggle and lazy-load)
      let copilotOpen = false;
      const linkPrompts = document.getElementById('linkCopilotPrompts');
      const boxEl = document.getElementById('copilotBox');
      const listEl = document.getElementById('copilotList');
      const statusEl = document.getElementById('copilotStatus');

      linkPrompts?.addEventListener('click', (e) => {
        e.preventDefault();
        if (!boxEl) return;
        copilotOpen = !copilotOpen;
        boxEl.style.display = copilotOpen ? 'block' : 'none';
        linkPrompts.setAttribute('aria-expanded', copilotOpen ? 'true' : 'false');

        if (copilotOpen && listEl && listEl.childElementCount === 0) {
          if (statusEl) statusEl.textContent = 'Loading…';
          vscode.postMessage({ type: 'getCopilotPrompts' });
        }
      });

      // State sync + render copilot prompts
      window.addEventListener('message', (ev) => {
        const msg = ev.data || {};
        if (msg.type === 'state') {
          const now = Date.now();

          if (typeof msg.cloudStarted === 'boolean') {
            // Ignore a transient "false" right after a start click
            if (msg.cloudStarted === false && (now - lastCloudStartAt) < JUST_STARTED_MS) {
              // ignore transient false
            } else {
              document.body.setAttribute('data-cloud-started', msg.cloudStarted ? '1' : '0');
              setCloudVisual(msg.cloudStarted);
            }
          }

          if (typeof msg.localStarted === 'boolean') {
            // Ignore a transient "false" right after a start click
            if (msg.localStarted === false && (now - lastLocalStartAt) < JUST_STARTED_MS) {
              // ignore transient false
            } else {
              document.body.setAttribute('data-local-started', msg.localStarted ? '1' : '0');
              setLocalVisual(msg.localStarted);
            }
          }
        }

        if (msg.type === 'copilotPrompts') {
          if (!listEl || !statusEl) return;
          listEl.innerHTML = '';
          statusEl.textContent = msg.error ? ('Error: ' + msg.error) : '';

          const items = Array.isArray(msg.items) ? msg.items : [];
          if (!items.length && !msg.error) {
            statusEl.textContent = 'No prompt examples found.';
            return;
          }

          for (const txt of items) {
            const li = document.createElement('li');
            li.style.listStyle = 'disc';
            li.style.margin = '6px 0';

            const code = document.createElement('code');
            code.textContent = txt;
            code.style.userSelect = 'text';
            code.style.whiteSpace = 'pre-wrap';
            code.style.wordBreak = 'break-word';
            code.style.padding = '2px 4px';
            code.style.border = '1px solid var(--vscode-widget-border, transparent)';
            code.style.borderRadius = '4px';
            code.style.display = 'inline-block';
            code.style.maxWidth = '100%';

            const btn = document.createElement('button');
            btn.textContent = 'Copy';
            btn.style.marginLeft = '8px';
            btn.addEventListener('click', async (e) => {
              e.preventDefault();
              try {
                await navigator.clipboard.writeText(txt);
                const old = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = old; }, 1000);
              } catch {
                statusEl.textContent = 'Clipboard copy failed.';
              }
            });

            li.appendChild(code);
            li.appendChild(btn);
            listEl.appendChild(li);
          }
        }
      });
    })();
  </script>
</body>
</html>
